# WARNING: This file is automatically generated by an Ansible template.
# Any custom modifications made directly to this file will be overwritten
# during future Ansible runs.

# Please place any custom configurations in the following file
# /etc/nginx/custom/default.conf 

# configurations in  /etc/nginx/static/default.conf are be included in this nginx configuration.


# Let local monitoring agent access stats
server {
  listen 127.0.0.1;
  server_name localhost;
  location /nginx_status {
    stub_status on;
    access_log   off;
    allow 127.0.0.1;
    deny all;
  }
}

# http block
server {
  listen {{ http_port | default('80') }};
  server_name _;
  return 302 https://$host:{{ https_port | default("$server_port") }}$request_uri;
}

# https block 
server {
  listen {{ https_port | default('443') }} ssl;
  server_name _;
  include static/default.conf;
{% for instance in groups['instances']  if 'ROOT' not in groups['instances'] |
map('extract', hostvars, 'dhis2_base_path') | map('default', 'None') and
(hostvars[instance]['proxy_rewrite'] | default(false) == true or
hostvars[instance]['proxy_rewrite'] | default('false') == "true") %} 
{% if loop.first %}
  # in case your want '/' access re-written to /{{ hostvars[instance]['dhis2_base_path']  | default(instance) | to_fixed_string }}; 
  rewrite ^/$ /{{ hostvars[instance]['dhis2_base_path']  | default(instance) | to_fixed_string }}; 
{%endif%}
{%endfor%}
# Location configuration 
  {% for instance  in groups['instances'] if (hostvars[instance]['fqdn'] is undefined)
  or hostvars[instance]['fqdn'] == None or  (not hostvars[instance]['fqdn'] | trim != "") -%}
  # location configs for dhis2 instance
  include  conf.d/upstream/{{ instance | to_fixed_string }}.conf;
  {%endfor%}

{% if server_monitoring is defined -%}
{% set server_monitoring_lower = server_monitoring | lower | trim %}
{% if server_monitoring_lower == 'munin' %}
  # location config for munin server monitoring
  include conf.d/upstream/munin.conf;
  {% elif server_monitoring  in  ['grafana', 'prometheus', 'grafana/prometheus'] -%}
  include conf.d/upstream/grafana.conf;
  {% else %}
  # server_monitoring is defined but doesn't match glowroot or prometheus
  # Add a default include or log a warning if needed
  # Example: include conf.d/upstream/default.conf;
  {% endif %}
  {% else %}
    # server_monitoring is not defined
    # Handle the case where server_monitoring is not set
    # Example: include conf.d/upstream/default.conf;
  {% endif %}

{% for instance  in groups['instances'] if 'ROOT' not in groups['instances'] |
    map('extract', hostvars, 'dhis2_base_path') | map('default', 'None') %}
{% if loop.first %}
location / {
  return 444;
  }
{%endif%}
{%endfor%}
}

